apiVersion: v1
kind: ConfigMap
metadata:
  name: indy-config
data:
  indy_config.py: |-
    # Current network
    NETWORK_NAME = '{{ .Values.network_name }}'

    # Disable stdout logging
    enableStdOutLogging = False

    # Directory to store ledger.
    LEDGER_DIR = '/var/lib/indy'

    # Directory to store logs.
    LOG_DIR = '/var/log/indy'

    # Directory to store keys.
    KEYS_DIR = '/var/lib/indy'

    # Directory to store genesis transactions files.
    GENESIS_DIR = '/var/lib/indy'

    # Directory to store backups.
    BACKUP_DIR = '/var/lib/indy/backup'

    # Directory to store plugins.
    PLUGINS_DIR = '/var/lib/indy/plugins'

    # Directory to store node info.
    NODE_INFO_DIR = '/var/lib/indy'
  {{- range $node := .Values.nodes }}
  indy.env-{{ $node.alias }}: |-
    NODE_NAME={{ $node.alias }}
    NODE_IP=0.0.0.0
    NODE_PORT={{ $node.node_port }}
    NODE_CLIENT_IP=0.0.0.0
    NODE_CLIENT_PORT={{  $node.client_port }}
    CLIENT_CONNECTIONS_LIMIT=500
  {{- end}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: indy-node-cm-genesis
data:
  domain_transactions_genesis: |-
    {"reqSignature":{},"txn":{"data":{"alias":"trustee1","dest":"Jpm5DnYt65H8y2TViUTNAB","role":"0","verkey":"AiSBt5bv18Z9qsGcr22wynfajEfELCyi1jxqo4fAPLvP"},"metadata":{},"type":"1"},"txnMetadata":{"seqNo":1},"ver":"1"}
    {"reqSignature":{},"txn":{"data":{"alias":"trustee2","dest":"XqwsmUXnQD8FomAZ2kCaZY","role":"0","verkey":"Hp37bcWfdnSWgqExnCBWPVP4M9k5NNs7966KVW77qHi1"},"metadata":{},"type":"1"},"txnMetadata":{"seqNo":2},"ver":"1"}
    {"reqSignature":{},"txn":{"data":{"alias":"trustee3","dest":"YVp8i9tRDpsqqfNhEqc1Ty","role":"0","verkey":"JAg9dZ5dRKHPrCzpb6N2JZd2xhBTNJgSAKByFzs43xHP"},"metadata":{},"type":"1"},"txnMetadata":{"seqNo":3},"ver":"1"}
    {"reqSignature":{},"txn":{"data":{"alias":"trustee4","dest":"NuKxNzV8D9wxMS6qfhfYMz","role":"0","verkey":"CwNY1fAJBC1FEEqG2iaDo5qJ52mUvofErmwU3pVNibTq"},"metadata":{},"type":"1"},"txnMetadata":{"seqNo":4},"ver":"1"}
    {"reqSignature":{},"txn":{"data":{"alias":"trustee5","dest":"6hgQt4SXMrrgiuYVehsVyG","role":"0","verkey":"47ES1rqs6AXP5vczP3Tssy2m6SRJpLcD1zXPUecUgWpd"},"metadata":{},"type":"1"},"txnMetadata":{"seqNo":5},"ver":"1"}
    {"reqSignature":{},"txn":{"data":{"dest":"DymSqG3FM1zVZ1NnTTYwxN","role":"2","verkey":"85HRkWJ1VJ91ktBWtFfLQou3Caquacqoy7XwQbBXSaPc"},"metadata":{"from":"6hgQt4SXMrrgiuYVehsVyG"},"type":"1"},"txnMetadata":{"seqNo":6},"ver":"1"}
    {"reqSignature":{},"txn":{"data":{"dest":"NP7Wm86zaWoZs2Rx755q63","role":"2","verkey":"CeuPsj2Z7cGvgWDp53BKrukWykuUoPWdzukxmpBcoWyr"},"metadata":{"from":"6hgQt4SXMrrgiuYVehsVyG"},"type":"1"},"txnMetadata":{"seqNo":7},"ver":"1"}
    {"reqSignature":{},"txn":{"data":{"dest":"W8z2nhcHXhPgqPYyroSANN","role":"2","verkey":"Gt6hoGtSweBhYsabQHPapAoMrk8YoxSYtphnM128GwVY"},"metadata":{"from":"6hgQt4SXMrrgiuYVehsVyG"},"type":"1"},"txnMetadata":{"seqNo":8},"ver":"1"}
    {"reqSignature":{},"txn":{"data":{"dest":"TrhdtzmyY8xVXk7YVeP3kt","role":"2","verkey":"FdzzH3vUvgwumKeKWsatuC1MaPsPXey2upxUFmoXtngd"},"metadata":{"from":"6hgQt4SXMrrgiuYVehsVyG"},"type":"1"},"txnMetadata":{"seqNo":9},"ver":"1"}

  pool_transactions_genesis: |-
    {"reqSignature":{},"txn":{"data":{"data":{"alias":"steward1","blskey":"3WrmDaXEEFeXBFNBj5z9pJM8YMkzvKwXGiZfgL3UaAHv55iMykaTyApzjNMDycRcV76N3fRn1K93HLQPEcqUHg8DkSb98KoZEC5cKGL7szQ8w8NNmUSdUkyR91VS5nbhWdmq7HXHyX7wdG1pThwpfzJ7gYghhxG4KinQv6zUGDXX5Dw","blskey_pop":"QsUGJQKzPmm9ZjU85kTyrU8oHcLZWpMoA5nHYUgr9YGb6ErfDEGYdw39LdWAwGvZ6J8izegw1oJBQ7rfjqDRGdVDDxSXDPEuDrFw6CCy68RWQudxEHqdADnGPYS9KFmndM7m1KSg5mJJQjuVN2MLJLFFnQicpBpPRCS37Hvj5fVavT","client_ip":"steward1.default.svc.cluster.local","client_port":"steward1_9702","node_ip":"steward1.default.svc.cluster.local","node_port":"steward1_9701","services":["VALIDATOR"]},"dest":"J9URhJ546VdmnozJgtvG5surifviGxNSbsdjnWupcpHU"},"metadata":{"from":"DymSqG3FM1zVZ1NnTTYwxN"},"type":"0"},"txnMetadata":{"seqNo":1,"txnId":"d217afd29dd422162e5c528f3fd023397c8469b9e3f00f46835d0e671006f50b"},"ver":"1"}
    {"reqSignature":{},"txn":{"data":{"data":{"alias":"steward2","blskey":"3AVa9BnjbueTT2NCj4XT2dkDoupYtBuCFjfTi6tWwqdgBa2PB393BiaDfqSGzrKMHjzZyHQENryDYmdskgaPq4ZzdQyv6NE33xfEX1dxtXyt8DQNVCfuSiRtJ5gbZ4uyH66vtrdHWh6sY4BeeDZgEjmAGfksCeiSiYgGchRs8YRgVVT","blskey_pop":"R6mKe3nxTgHyHPvC6dCEoUrWgkJhJ6oiDeQKMy7pbEEoQWE2Piw4Jk8o4jNjtBhCda7iyJY2zrMCP6eAb8W7rXrqqqQrJA9YHTYGn4BCGcsYBNSQ7uamkGrpPTjSxAAbDR5vGiQS1L6gXhwqE278LKM3Ap59MhyG6iKziEQUPVzecw","client_ip":"steward2.default.svc.cluster.local","client_port":"steward2_9702","node_ip":"steward2.default.svc.cluster.local","node_port":"steward2_9701","services":["VALIDATOR"]},"dest":"ANKwe3rSuBc9QkS6hGXVJjog44LyxDdy3stDvCWBFLCA"},"metadata":{"from":"NP7Wm86zaWoZs2Rx755q63"},"type":"0"},"txnMetadata":{"seqNo":2,"txnId":"b69e5fbf21173123d5733231a5e1cbcf53233f2ed08695daefab12dca9092114"},"ver":"1"}
    {"reqSignature":{},"txn":{"data":{"data":{"alias":"steward3","blskey":"2aAythRosUoPwwsaHEvWTTZDF1ZoH4bM9dU1Q4VRF1cT9c5NcTEvHgCPDDaKLdXEM7QCEqPBKEbqQqZEAxTLwerbzHh852f2JC8iKYd6akZyaK35WUBoPxTDonxJMjXoKvFSxS9k5v9GcQ4sJiVpbgmfRfnKTT4G4r237RYVS1GyV1z","blskey_pop":"RRwnXmTwiXYAUyoAHC2eR5HBwzTfhYNHYonMMnfaYho7cdRF4Z9p773W3W6hi7xb25PHbjzh976B4DtQ9cHxtgXXzpzB4ieCT6Q37jqmDybRPiuisFN4SaiA1JkxrhyrVsxDWcGYUi23aYRAP8zzSduSoumN3k4HCbJd5vgkdvTo7D","client_ip":"steward3.default.svc.cluster.local","client_port":"steward3_9702","node_ip":"steward3.default.svc.cluster.local","node_port":"steward3_9701","services":["VALIDATOR"]},"dest":"5EMB1DqqF37ZVLDsFkae3ssKBgU1Lbbitpw6dbSaJ4wy"},"metadata":{"from":"W8z2nhcHXhPgqPYyroSANN"},"type":"0"},"txnMetadata":{"seqNo":3,"txnId":"f05151122ea0c4c8bdea1ed2bae305bb37934a0c92a566a627abb1d1c9778b9f"},"ver":"1"}
    {"reqSignature":{},"txn":{"data":{"data":{"alias":"steward4","blskey":"3DP4UFx9wy8xGjAE1qXX5mk8GGJXYcYrKfzsVXd93BByq5bLCdoeYfa4MjBenVVDYApKfAhtiHBpZxfgxMVmyPczuEpWs2RiKcc8ZEa2qRaLyACjx9aKYvvjgfYNfyWe9X96XtKmyceDmm5ZesLs6qgpwc5qqnyYXnbfcnXT58HrpU5","blskey_pop":"R7PPtJwVS7uNGa5oQnxBhsYQshTbvbNttW1KokZtFC12sMj5bfbr7esEGz1SUbo32kDMiireCKU5XDJPQkGw85j6Y9H69ytxTZqjJJFxkcfos4XJJHmP8tMEw8oYUyqWmTzG8MSUpibgVGfphvwPV6DPQCm9zYUg5q2JCMtDbTxPz7","client_ip":"steward4.default.svc.cluster.local","client_port":"steward4_9702","node_ip":"steward4.default.svc.cluster.local","node_port":"steward4_9701","services":["VALIDATOR"]},"dest":"38LvqLxa1UHThsREaRaLBDyuoCSe1e3h4W16YRTWDAyZ"},"metadata":{"from":"TrhdtzmyY8xVXk7YVeP3kt"},"type":"0"},"txnMetadata":{"seqNo":4,"txnId":"34569ec776a6f8cf766aece248c78fd21f652a08f3f44daae23c9cbc07623601"},"ver":"1"}

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: scripts-cm
data:
  entrypoint.sh: |-
    #!/bin/sh
    {{ if .Release.IsInstall }}
    init_indy_node $node 0.0.0.0 $C_NODE_PORT 0.0.0.0 $C_CLIENT_PORT > /extdata/$node
    {{ end }}
    
    {{ if .Release.IsUpgrade }}
    cp /var/lib/indy/{{ .Values.network_name }}/pool_transactions_genesis_readonly /var/lib/indy/{{ .Values.network_name }}/pool_transactions_genesis
    cp /var/lib/indy/{{ .Values.network_name }}/domain_transactions_genesis_readonly /var/lib/indy/{{ .Values.network_name }}/domain_transactions_genesis
    
    {{- range $inter_node := .Values.nodes }}
    sed -i "0,/{{ $inter_node.alias }}.default.svc.cluster.local/s//${{ upper $inter_node.alias }}_SERVICE_HOST/" /var/lib/indy/{{ $.Values.network_name }}/pool_transactions_genesis
    sed -i "0,/{{ $inter_node.alias }}_9702/s//${{ upper $inter_node.alias }}_SERVICE_PORT_CLIENT/" /var/lib/indy/{{ $.Values.network_name }}/pool_transactions_genesis
    sed -i "0,/{{ $inter_node.alias }}.default.svc.cluster.local/s//${{ upper $inter_node.alias }}_SERVICE_HOST/" /var/lib/indy/{{ $.Values.network_name }}/pool_transactions_genesis
    sed -i "0,/{{ $inter_node.alias }}_9701/s//${{ upper $inter_node.alias }}_SERVICE_PORT_NODE/" /var/lib/indy/{{ $.Values.network_name }}/pool_transactions_genesis
    {{- end }}
    start_indy_node $node 0.0.0.0 $C_NODE_PORT 0.0.0.0 $C_CLIENT_PORT &
    {{ end }}